<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Tuning persistent homological hyperparameters • tdarec</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Tuning persistent homological hyperparameters">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tdarec</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/hyperparameter-tuning.html">Tuning persistent homological hyperparameters</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tdaverse/tdarec/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Tuning persistent homological hyperparameters</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tdaverse/tdarec/blob/HEAD/vignettes/hyperparameter-tuning.Rmd" class="external-link"><code>vignettes/hyperparameter-tuning.Rmd</code></a></small>
      <div class="d-none name"><code>hyperparameter-tuning.Rmd</code></div>
    </div>

    
    
<p>This vignette will illustrate the tuning of hyperparameters at two
pre-processing steps provided by {tdarec}: the computation of persistent
homology from data, and the vectorization of the resulting persistence
data. Because the logic and syntax can become confusing, the vignette
will also illustrate how to tune model hyperparameters in the same
workflow as those of the pre-processing recipe.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Because hyperparameter tuning is time-consuming, this
vignette is pre-compiled before the package is built, to reduce CRAN
checktime in particular.&lt;/p&gt;"><sup>1</sup></a></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; ── Attaching packages ────────────────────────────────────── tidymodels 1.3.0 ──</span></span>
<span><span class="co">#&gt; ✔ broom        1.0.8     ✔ recipes      1.3.0</span></span>
<span><span class="co">#&gt; ✔ dials        1.4.0     ✔ rsample      1.3.0</span></span>
<span><span class="co">#&gt; ✔ dplyr        1.1.4     ✔ tibble       3.2.1</span></span>
<span><span class="co">#&gt; ✔ ggplot2      3.5.2     ✔ tidyr        1.3.1</span></span>
<span><span class="co">#&gt; ✔ infer        1.0.8     ✔ tune         1.3.0</span></span>
<span><span class="co">#&gt; ✔ modeldata    1.4.0     ✔ workflows    1.2.0</span></span>
<span><span class="co">#&gt; ✔ parsnip      1.3.1     ✔ workflowsets 1.1.0</span></span>
<span><span class="co">#&gt; ✔ purrr        1.0.4     ✔ yardstick    1.3.2</span></span>
<span><span class="co">#&gt; ── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──</span></span>
<span><span class="co">#&gt; ✖ purrr::discard() masks scales::discard()</span></span>
<span><span class="co">#&gt; ✖ dplyr::filter()  masks stats::filter()</span></span>
<span><span class="co">#&gt; ✖ dplyr::lag()     masks stats::lag()</span></span>
<span><span class="co">#&gt; ✖ recipes::step()  masks stats::step()</span></span>
<span><span class="co">#&gt; • Learn how to get started at https://www.tidymodels.org/start/</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tdaverse/tdarec" class="external-link">tdarec</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="cubical-persistent-homology">cubical persistent homology<a class="anchor" aria-label="anchor" href="#cubical-persistent-homology"></a>
</h3>
<p>The persistent homology (PH) of a real-valued function on a manifold
is determined by the <em>sublevel set filtration</em>: Given
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo>:</mo><mi>X</mi><mo>→</mo><mstyle mathvariant="double-struck"><mi>ℝ</mi></mstyle></mrow><annotation encoding="application/x-tex">f : X \to \mathbb{R}</annotation></semantics></math>,
for each value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>∈</mo><mstyle mathvariant="double-struck"><mi>ℝ</mi></mstyle></mrow><annotation encoding="application/x-tex">r \in \mathbb{R}</annotation></semantics></math>
define
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>r</mi></msub><mo>=</mo><msup><mi>f</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy="false" form="prefix">(</mo><mo>−</mo><mi>∞</mi><mo>,</mo><mi>r</mi><mo stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">X_r = f^{-1}(-\infty,r]</annotation></semantics></math>,
so that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>r</mi></msub><mo>⊆</mo><msub><mi>X</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">X_r \subseteq X_s</annotation></semantics></math>
whenever
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>&lt;</mo><mi>s</mi></mrow><annotation encoding="application/x-tex">r &lt; s</annotation></semantics></math>.
Then the induced homomorphisms
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>r</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>→</mo><msub><mi>H</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>s</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">H_k(X_r) \to H_k(X_s)</annotation></semantics></math>
between (singular) homology groups form a <em>persistence module</em>
whose decomposition obtains the birth–death pairs that comprise the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>k</mi><mtext mathvariant="normal">th</mtext></msup><annotation encoding="application/x-tex">k^\text{th}</annotation></semantics></math>
persistence diagram of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>.</p>
<p>While some such computations can be done analytically, most data come
in the form of discrete measurements rather than functional
relationships. For example, the topographic data for the Maunga Whau
caldera take the form of a 2-dimensional numeric array, with each cell
containing the estimated elevation of a 100–square meter area:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/filled.contour.html" class="external-link">filled.contour</a></span><span class="op">(</span><span class="va">volcano</span>, color.palette <span class="op">=</span> <span class="va">terrain.colors</span>, asp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="vignette-volcano-1.png" alt=""><p class="caption">plot of chunk volcano</p>
</div>
<p>This is a discretization of a height function from latitude and
longitude
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mstyle mathvariant="double-struck"><mi>𝕊</mi></mstyle><mn>2</mn></msup><annotation encoding="application/x-tex">\mathbb{S}^2</annotation></semantics></math>,
approximated locally by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mstyle mathvariant="double-struck"><mi>ℝ</mi></mstyle><mn>2</mn></msup><annotation encoding="application/x-tex">\mathbb{R}^2</annotation></semantics></math>)
to elevation
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mstyle mathvariant="double-struck"><mi>ℝ</mi></mstyle><annotation encoding="application/x-tex">\mathbb{R}</annotation></semantics></math>),
and cubical persistent homology is an alternative to the simplicial
computation designed specifically for data in this form. The {ripserr}
package ports the Cubical Ripser algorithm to R and serves as the engine
for this pre-processing step.</p>
</div>
<div class="section level3">
<h3 id="handwritten-digits-data">handwritten digits data<a class="anchor" aria-label="anchor" href="#handwritten-digits-data"></a>
</h3>
<p>The <a href="https://en.wikipedia.org/wiki/MNIST_database" class="external-link">MNIST
handwritten digits data set</a> comprises 70,000
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>28</mn><mo>×</mo><mn>28</mn></mrow><annotation encoding="application/x-tex">28 \times 28</annotation></semantics></math>
pixellated black-and-white images of the numerals 0–9 obtained from
forms completed by US Census Bureau field staff and Maryland high school
students. The images are partitioned into a training set of 60,000 and a
testing set of 10,000, and {tdavec} comes with a 1% random sample from
each. For example, here are the first six digits, labeled
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>,</mo><mn>6</mn><mo>,</mo><mn>6</mn><mo>,</mo><mn>2</mn><mo>,</mo><mn>7</mn><mo>,</mo><mn>9</mn></mrow><annotation encoding="application/x-tex">1, 6, 6, 2, 7, 9</annotation></semantics></math>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">.5</span>, <span class="fl">.5</span>, <span class="fl">.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">r</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span></span>
<span>    <span class="va">mnist_train</span><span class="op">$</span><span class="va">digit</span><span class="op">[[</span><span class="va">r</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.colors.html" class="external-link">grey.colors</a></span><span class="op">(</span><span class="fl">256</span>, start <span class="op">=</span> <span class="fl">0</span>, end <span class="op">=</span> <span class="fl">1</span>, rev <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    xaxt <span class="op">=</span> <span class="st">"n"</span>, yaxt <span class="op">=</span> <span class="st">"n"</span>, asp <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="figure">
<img src="vignette-mnist-datum-1.png" alt=""><p class="caption">plot of chunk mnist-datum</p>
</div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.1</span><span class="op">)</span></span></code></pre></div>
<p>(That the digits are rotated from their usual orientation is not a
problem for the methods used here.) To respect Tidymodels conventions,
we convert the <code>label</code> column from integer to factor before
continuing.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mnist_train</span><span class="op">$</span><span class="va">label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">mnist_train</span><span class="op">$</span><span class="va">label</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">mnist_train</span><span class="op">$</span><span class="va">label</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mnist_test</span><span class="op">$</span><span class="va">label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">mnist_test</span><span class="op">$</span><span class="va">label</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">mnist_test</span><span class="op">$</span><span class="va">label</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="preparation">preparation<a class="anchor" aria-label="anchor" href="#preparation"></a>
</h3>
<p>Following a standard ML approach, we prepare the training set for
6-fold cross-validation, which will be used to choose hyperparameter
settings that maximize the accuracy of a classifier. The optimized
settings will be used to classify the digits in the testing set, and a
comparison with the true labels will provide an estimate of the accuracy
of the resulting model.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">mnist_folds</span> <span class="op">&lt;-</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">mnist_train</span>, v <span class="op">=</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; #  6-fold cross-validation </span></span>
<span><span class="co">#&gt; # A tibble: 6 × 2</span></span>
<span><span class="co">#&gt;   splits            id   </span></span>
<span><span class="co">#&gt;   &lt;list&gt;            &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1 &lt;split [500/100]&gt; Fold1</span></span>
<span><span class="co">#&gt; 2 &lt;split [500/100]&gt; Fold2</span></span>
<span><span class="co">#&gt; 3 &lt;split [500/100]&gt; Fold3</span></span>
<span><span class="co">#&gt; 4 &lt;split [500/100]&gt; Fold4</span></span>
<span><span class="co">#&gt; 5 &lt;split [500/100]&gt; Fold5</span></span>
<span><span class="co">#&gt; 6 &lt;split [500/100]&gt; Fold6</span></span></code></pre></div>
<p>For reference, we check the range of the values that populate the
arrays:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">mnist_train</span><span class="op">$</span><span class="va">digit</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]   0 255</span></span></code></pre></div>
<p>This indicates that the greyscale images are coded as integers
between
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>8</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^8 - 1</annotation></semantics></math>,
and we will use this information to inform our pre-processing steps.</p>
</div>
<div class="section level2">
<h2 id="a-fixed-parameter-walkthrough">a fixed-parameter walkthrough<a class="anchor" aria-label="anchor" href="#a-fixed-parameter-walkthrough"></a>
</h2>
<p>Before taking on the challenge of tuning, we walk through the
modeling process using fixed parameters. This will help ensure that our
approach is sound, for example by prompting us to think through our
choices and flagging unforeseen problems. It will also allow us to
compare the performance of the model under “trialed” versus tuned
parameter settings.</p>
<div class="section level3">
<h3 id="pre-processing-recipe">pre-processing recipe<a class="anchor" aria-label="anchor" href="#pre-processing-recipe"></a>
</h3>
<p>The first step is to prepare the pre-processing recipe. Ours goes in
three steps: Blur the original images, compute their cubical persistence
diagrams, and transform these diagrams into vectorized persistence
landscapes. We comment on each step:</p>
<ol style="list-style-type: decimal">
<li>One limitation of cubical persistent homology is that it is
sensitive only to the height difference between cells in the array, not
the distances between them; see <a href="http://arxiv.org/abs/2005.12692" class="external-link">Kaji, Sudo, &amp; Ahara
(2020)</a> for a detailed discussion. So, on topographic data, a steep
peak and a gentle mound of the same height will be encoded as the same
feature. This is likely to be a problem in the classification of digits,
as for example the numerals
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>6</mn><annotation encoding="application/x-tex">6</annotation></semantics></math>
have one “hole” each so are indistinguishable from a purely topological
perspective. We can make the PH sensitive to distance by first
convolving the image with a small bivariate Gaussian distribution. This
<em>blur</em> reduces the height difference between nearby positions but
retains that between distant positions. For this untuned model, we allow
<code><a href="../reference/step_blur.html">step_blur()</a></code> to compute a default standard deviation for the
Gaussian as described in <code><a href="../reference/blur.html">help(blur)</a></code>.</li>
<li>Cubical persistent homology is a parameter-free computation, so no
tuning is required or even possible. (With point clouds, we might care
about the highest-degree features being computed, but for our height
functions on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mstyle mathvariant="double-struck"><mi>ℝ</mi></mstyle><mn>2</mn></msup><annotation encoding="application/x-tex">\mathbb{R}^2</annotation></semantics></math>
the upper bound for non-zero homology is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>−</mo><mn>1</mn><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2 - 1 = 1</annotation></semantics></math>.)</li>
<li>{TDAvec} provides over a dozen vectorization methods for persistence
diagrams, and each carries strengths and weaknesses. Our choice to use
persistence landscapes in this vignette is somewhat arbitrary, but the
nuance of the step allows us to illustrate optimization using two
hyperparameters (the homological degree of the diagram to transform and
the number of landscape levels to vectorize) and to point out some
adjustable default behavior. We use our knowledge of the value range to
specify a grid.</li>
</ol>
<p>Only the final pre-processing step yields new numeric columns that
can be used as predictors in a conventional model. For this reason, the
PH step by default assigns the placeholder role
<code>"persistence diagram"</code> to its output, so that the new
<code>digit_pd</code> column will not accidentally be used as a
predictor. In contrast, the blur step modifies its column
<code>digit</code> in place, and <a href="https://recipes.tidymodels.org/articles/Roles.html#role-inheritance" class="external-link">the
modified column inherits the role(s) of the original</a>. This requires
us to update the role of <code>digit</code>, but this can be done before
or after applying the blur.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">mnist_train</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">update_role</a></span><span class="op">(</span><span class="va">label</span>, new_role <span class="op">=</span> <span class="st">"outcome"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">update_role</a></span><span class="op">(</span><span class="va">digit</span>, new_role <span class="op">=</span> <span class="st">"image"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/step_blur.html">step_blur</a></span><span class="op">(</span><span class="va">digit</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_pd_raster.html">step_pd_raster</a></span><span class="op">(</span><span class="va">digit</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/step_vpd_persistence_landscape.html">step_vpd_persistence_landscape</a></span><span class="op">(</span></span>
<span>    <span class="va">digit_pd</span>,</span>
<span>    hom_degree <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    xmin <span class="op">=</span> <span class="fl">0</span>, xmax <span class="op">=</span> <span class="fl">255</span>, xby <span class="op">=</span> <span class="fl">16</span>,</span>
<span>    num_levels <span class="op">=</span> <span class="fl">3</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">mnist_rec</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Recipe ──────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Inputs</span></span>
<span><span class="co">#&gt; Number of variables by role</span></span>
<span><span class="co">#&gt; outcome: 1</span></span>
<span><span class="co">#&gt; image:   1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Operations</span></span>
<span><span class="co">#&gt; • Gaussian blurring of: digit</span></span>
<span><span class="co">#&gt; • persistent features from a cubical filtration of: digit</span></span>
<span><span class="co">#&gt; • persistence landscape of: digit_pd</span></span></code></pre></div>
<p>We can check directly whether our role assignments obtained as
expected:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mnist_rec</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">mnist_prep</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Recipe ──────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Inputs</span></span>
<span><span class="co">#&gt; Number of variables by role</span></span>
<span><span class="co">#&gt; outcome: 1</span></span>
<span><span class="co">#&gt; image:   1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Training information</span></span>
<span><span class="co">#&gt; Training data contained 600 data points and no incomplete rows.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Operations</span></span>
<span><span class="co">#&gt; • Gaussian blurring of: &lt;none&gt; | Trained</span></span>
<span><span class="co">#&gt; • persistent features from a cubical filtration of: &lt;none&gt; | Trained</span></span>
<span><span class="co">#&gt; • persistence landscape of: &lt;none&gt; | Trained</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mnist_prep</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 51 × 4</span></span>
<span><span class="co">#&gt;    variable        type      role                source  </span></span>
<span><span class="co">#&gt;    &lt;chr&gt;           &lt;list&gt;    &lt;chr&gt;               &lt;chr&gt;   </span></span>
<span><span class="co">#&gt;  1 digit           &lt;chr [1]&gt; image               original</span></span>
<span><span class="co">#&gt;  2 label           &lt;chr [3]&gt; outcome             original</span></span>
<span><span class="co">#&gt;  3 digit_pd        &lt;chr [1]&gt; persistence diagram derived </span></span>
<span><span class="co">#&gt;  4 digit_pd_pl_1_1 &lt;chr [2]&gt; predictor           derived </span></span>
<span><span class="co">#&gt;  5 digit_pd_pl_1_2 &lt;chr [2]&gt; predictor           derived </span></span>
<span><span class="co">#&gt;  6 digit_pd_pl_1_3 &lt;chr [2]&gt; predictor           derived </span></span>
<span><span class="co">#&gt;  7 digit_pd_pl_1_4 &lt;chr [2]&gt; predictor           derived </span></span>
<span><span class="co">#&gt;  8 digit_pd_pl_1_5 &lt;chr [2]&gt; predictor           derived </span></span>
<span><span class="co">#&gt;  9 digit_pd_pl_1_6 &lt;chr [2]&gt; predictor           derived </span></span>
<span><span class="co">#&gt; 10 digit_pd_pl_1_7 &lt;chr [2]&gt; predictor           derived </span></span>
<span><span class="co">#&gt; # ℹ 41 more rows</span></span></code></pre></div>
<p>And we can inspect the result of applying the prepared recipe to the
training data:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mnist_rec</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="va">mnist_train</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 600 × 51</span></span>
<span><span class="co">#&gt;    digit    label digit_pd       digit_pd_pl_1_1 digit_pd_pl_1_2 digit_pd_pl_1_3</span></span>
<span><span class="co">#&gt;    &lt;list&gt;   &lt;fct&gt; &lt;list&gt;                   &lt;dbl&gt;           &lt;dbl&gt;           &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 &lt;dbl[…]&gt; 1     &lt;PHom [7 × 3]&gt;               0               0            3.15</span></span>
<span><span class="co">#&gt;  2 &lt;dbl[…]&gt; 6     &lt;PHom [4 × 3]&gt;               0               0            0   </span></span>
<span><span class="co">#&gt;  3 &lt;dbl[…]&gt; 6     &lt;PHom [4 × 3]&gt;               0               0            0   </span></span>
<span><span class="co">#&gt;  4 &lt;dbl[…]&gt; 2     &lt;PHom [6 × 3]&gt;               0               0            0   </span></span>
<span><span class="co">#&gt;  5 &lt;dbl[…]&gt; 7     &lt;PHom [4 × 3]&gt;               0               0            0   </span></span>
<span><span class="co">#&gt;  6 &lt;dbl[…]&gt; 9     &lt;PHom [4 × 3]&gt;               0               0            0   </span></span>
<span><span class="co">#&gt;  7 &lt;dbl[…]&gt; 2     &lt;PHom [5 × 3]&gt;               0               0            5.49</span></span>
<span><span class="co">#&gt;  8 &lt;dbl[…]&gt; 0     &lt;PHom [7 × 3]&gt;               0               0            0   </span></span>
<span><span class="co">#&gt;  9 &lt;dbl[…]&gt; 4     &lt;PHom [5 × 3]&gt;               0               0            0   </span></span>
<span><span class="co">#&gt; 10 &lt;dbl[…]&gt; 3     &lt;PHom [5 × 3]&gt;               0               0            0   </span></span>
<span><span class="co">#&gt; # ℹ 590 more rows</span></span>
<span><span class="co">#&gt; # ℹ 45 more variables: digit_pd_pl_1_4 &lt;dbl&gt;, digit_pd_pl_1_5 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   digit_pd_pl_1_6 &lt;dbl&gt;, digit_pd_pl_1_7 &lt;dbl&gt;, digit_pd_pl_1_8 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   digit_pd_pl_1_9 &lt;dbl&gt;, digit_pd_pl_1_10 &lt;dbl&gt;, digit_pd_pl_1_11 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   digit_pd_pl_1_12 &lt;dbl&gt;, digit_pd_pl_1_13 &lt;dbl&gt;, digit_pd_pl_1_14 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   digit_pd_pl_1_15 &lt;dbl&gt;, digit_pd_pl_1_16 &lt;dbl&gt;, digit_pd_pl_2_1 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   digit_pd_pl_2_2 &lt;dbl&gt;, digit_pd_pl_2_3 &lt;dbl&gt;, digit_pd_pl_2_4 &lt;dbl&gt;, …</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="classification-forest">classification forest<a class="anchor" aria-label="anchor" href="#classification-forest"></a>
</h3>
<p>In the next code chunk we specify a random forest (RF) model to
classify the digits using vectorized persistence landscapes. RFs are
ubiquitous in ML for their combination of flexibility and performance:
They can be used almost anywhere and generally produce more models that
are competitive with or superior to classical models like decision trees
and generalized linear models. They also come with a medley of tuning
parameters. In this vignette, we demonstrate the use of 3
hyperparameters, each treated differently:</p>
<ul>
<li>The number <code>trees</code> of trees in each forest is fixed at
300.</li>
<li>The minimum node size will be tuned across its default range, though
here it is fixed at 6.</li>
<li>The number of predictors selected for each tree will also be tuned,
but the maximum value must be determined from the data. Here it is set
to 2.</li>
</ul>
<p>The {randomForest} engine is strict in its requirements: If all
predictors have zero variance, i.e. there is no way to generate
different predictors for different cases, then the model fails with an
error. This is a serious possibility for our setting, for instance if no
degree-1 features are detected so that the persistence landscapes are
uniformly zero. To prevent this from derailing our workflow, we use the
{ranger} engine, which is tolerant of this situation, instead.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rand_forest</span><span class="op">(</span></span>
<span>  trees <span class="op">=</span> <span class="fl">300</span>,</span>
<span>  min_n <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  mtry <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"ranger"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">mnist_spec</span></span>
<span><span class="co">#&gt; Random Forest Model Specification (classification)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Main Arguments:</span></span>
<span><span class="co">#&gt;   mtry = 2</span></span>
<span><span class="co">#&gt;   trees = 300</span></span>
<span><span class="co">#&gt;   min_n = 6</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computational engine: ranger</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fitting-and-evaluation">fitting and evaluation<a class="anchor" aria-label="anchor" href="#fitting-and-evaluation"></a>
</h3>
<p>We fit the model to the pre-processed training data:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fit</span><span class="op">(</span></span>
<span>  <span class="va">mnist_spec</span>,</span>
<span>  <span class="va">mnist_rec</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">mnist_rec</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="va">mnist_train</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">mnist_fit</span></span>
<span><span class="co">#&gt; parsnip model object</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Ranger result</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt;  ranger::ranger(x = maybe_data_frame(x), y = y, mtry = min_cols(~2,      x), num.trees = ~300, min.node.size = min_rows(~6, x), num.threads = 1,      verbose = FALSE, seed = sample.int(10^5, 1), probability = TRUE) </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Type:                             Probability estimation </span></span>
<span><span class="co">#&gt; Number of trees:                  300 </span></span>
<span><span class="co">#&gt; Sample size:                      600 </span></span>
<span><span class="co">#&gt; Number of independent variables:  48 </span></span>
<span><span class="co">#&gt; Mtry:                             2 </span></span>
<span><span class="co">#&gt; Target node size:                 6 </span></span>
<span><span class="co">#&gt; Variable importance mode:         none </span></span>
<span><span class="co">#&gt; Splitrule:                        gini </span></span>
<span><span class="co">#&gt; OOB prediction error (Brier s.):  0.786414</span></span></code></pre></div>
<p>Note that the model, while not optimized for accuracy on the training
set, is informed by it through the preparation process, in particular
the default choice of blur parameter:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mnist_prep</span><span class="op">$</span><span class="va">steps</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">blur_sigmas</span></span>
<span><span class="co">#&gt; digit </span></span>
<span><span class="co">#&gt;   3.5</span></span></code></pre></div>
<p>To evaluate the model, we generate predictions for the testing set
and compare them to the true labels. Because accuracy is a coarse metric
for a 10-value classification task, we examine the confusion matrix to
get a sense of what errors are most common.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mnist_fit</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="va">mnist_rec</span><span class="op">)</span>, new_data <span class="op">=</span> <span class="va">mnist_test</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">mnist_test</span>, <span class="va">label</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">mnist_pred</span></span>
<span><span class="co">#&gt; # A tibble: 100 × 2</span></span>
<span><span class="co">#&gt;    .pred_class label</span></span>
<span><span class="co">#&gt;    &lt;fct&gt;       &lt;fct&gt;</span></span>
<span><span class="co">#&gt;  1 7           0    </span></span>
<span><span class="co">#&gt;  2 4           1    </span></span>
<span><span class="co">#&gt;  3 4           4    </span></span>
<span><span class="co">#&gt;  4 4           1    </span></span>
<span><span class="co">#&gt;  5 1           2    </span></span>
<span><span class="co">#&gt;  6 2           0    </span></span>
<span><span class="co">#&gt;  7 1           4    </span></span>
<span><span class="co">#&gt;  8 2           9    </span></span>
<span><span class="co">#&gt;  9 3           6    </span></span>
<span><span class="co">#&gt; 10 7           0    </span></span>
<span><span class="co">#&gt; # ℹ 90 more rows</span></span>
<span><span class="va">mnist_pred</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">conf_mat</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">label</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span><span class="co">#&gt;           Truth</span></span>
<span><span class="co">#&gt; Prediction 0 1 2 3 4 5 6 7 8 9</span></span>
<span><span class="co">#&gt;          0 1 0 2 4 0 0 1 2 0 0</span></span>
<span><span class="co">#&gt;          1 0 6 1 0 2 1 0 0 0 0</span></span>
<span><span class="co">#&gt;          2 2 0 1 0 0 0 0 4 0 1</span></span>
<span><span class="co">#&gt;          3 1 0 3 2 0 1 4 0 3 1</span></span>
<span><span class="co">#&gt;          4 0 3 1 1 8 2 0 0 1 0</span></span>
<span><span class="co">#&gt;          5 0 1 0 1 0 2 0 0 0 0</span></span>
<span><span class="co">#&gt;          6 0 0 1 0 0 0 1 0 2 0</span></span>
<span><span class="co">#&gt;          7 5 0 0 2 0 4 2 2 1 5</span></span>
<span><span class="co">#&gt;          8 1 0 1 0 0 0 2 2 3 3</span></span>
<span><span class="co">#&gt;          9 0 0 0 0 0 0 0 0 0 0</span></span>
<span><span class="va">mnist_pred</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">accuracy</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">label</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 3</span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 accuracy multiclass      0.26</span></span></code></pre></div>
<p>The accuracy is poor but clearly better than chance. The confusion
matrix suggests some reasons for the misclassifications, in that the
most commonly confused digits are <em>not</em> those with the same
degree-1 homology; they are more geometrically than topologically
similar. This could be due to excessive blur; the standard deviation of
3.5 may be too high. We can compare this default to the value obtained
through tuning.</p>
</div>
</div>
<div class="section level2">
<h2 id="tuning-hyperparameters">tuning hyperparameters<a class="anchor" aria-label="anchor" href="#tuning-hyperparameters"></a>
</h2>
<p>We now extend the process above to choose, bound, and tune several
pre-processing and modeling hyperparameters.</p>
<div class="section level3">
<h3 id="tunable-pre-processing-recipe">tunable pre-processing recipe<a class="anchor" aria-label="anchor" href="#tunable-pre-processing-recipe"></a>
</h3>
<p>We rewrite the recipe to prepare the hyperparameters for tuning
rather than to assign them fixed values. Each parameter is given a
character ID that will refer to it in the various system messages and
outputs. Beware that this section of the vignette overwrites all
<code>mnist_*</code> variable names used in the previous section! This
is for readability but can cause problems if parts are executed out of
order.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">mnist_train</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">update_role</a></span><span class="op">(</span><span class="va">label</span>, new_role <span class="op">=</span> <span class="st">"outcome"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">update_role</a></span><span class="op">(</span><span class="va">digit</span>, new_role <span class="op">=</span> <span class="st">"image"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/step_blur.html">step_blur</a></span><span class="op">(</span><span class="va">digit</span>, blur_sigmas <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="st">"blur_sd"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_pd_raster.html">step_pd_raster</a></span><span class="op">(</span><span class="va">digit</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/step_vpd_persistence_landscape.html">step_vpd_persistence_landscape</a></span><span class="op">(</span></span>
<span>    <span class="va">digit_pd</span>,</span>
<span>    hom_degree <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="st">"pl_deg"</span><span class="op">)</span>,</span>
<span>    xmin <span class="op">=</span> <span class="fl">0</span>, xmax <span class="op">=</span> <span class="fl">255</span>, xby <span class="op">=</span> <span class="fl">16</span>,</span>
<span>    num_levels <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="st">"pl_lev"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">mnist_rec</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Recipe ──────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Inputs</span></span>
<span><span class="co">#&gt; Number of variables by role</span></span>
<span><span class="co">#&gt; outcome: 1</span></span>
<span><span class="co">#&gt; image:   1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Operations</span></span>
<span><span class="co">#&gt; • Gaussian blurring of: digit</span></span>
<span><span class="co">#&gt; • persistent features from a cubical filtration of: digit</span></span>
<span><span class="co">#&gt; • persistence landscape of: digit_pd</span></span></code></pre></div>
<p>This recipe has three tunable parameters, as we can verify by
extracting their dials:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span> <span class="va">rec_dials</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html" class="external-link">extract_parameter_set_dials</a></span><span class="op">(</span><span class="va">mnist_rec</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co">#&gt; Collection of 3 parameters for tuning</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  identifier        type    object</span></span>
<span><span class="co">#&gt;     blur_sd blur_sigmas nparam[?]</span></span>
<span><span class="co">#&gt;      pl_deg  hom_degree nparam[?]</span></span>
<span><span class="co">#&gt;      pl_lev  num_levels nparam[?]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Recipe parameters needing finalization:</span></span>
<span><span class="co">#&gt; Gaussian Blur std. dev.s ('blur_sd') , Homological Degree ('pl_deg') , and #</span></span>
<span><span class="co">#&gt; Levels or envelopes ('pl_lev')</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See `?dials::finalize()` or `?dials::update.parameters()` for more information.</span></span></code></pre></div>
<p>Note that all three require finalization; like the number of randomly
sampled predictors for each tree in a random forest, their ranges should
not be guessed but must be determined from the content of the data. In
fact, the persistence landscape hyperparameters must be determined from
columns derived by the first two steps from the input columns, not from
the input columns themselves. For this reason only, we train the recipe
with some intuitive values in order to obtain these derived columns for
tuning purposes:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mnist_rec</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">finalize_recipe</span><span class="op">(</span>parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>blur_sd <span class="op">=</span> <span class="fl">8</span>, pl_deg <span class="op">=</span> <span class="fl">0</span>, pl_lev <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="va">mnist_train</span><span class="op">)</span> <span class="op">-&gt;</span></span>
<span>  <span class="va">mnist_bake</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">mnist_bake</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 600 × 51</span></span>
<span><span class="co">#&gt;    digit    label digit_pd       digit_pd_pl_1_1 digit_pd_pl_1_2 digit_pd_pl_1_3</span></span>
<span><span class="co">#&gt;    &lt;list&gt;   &lt;fct&gt; &lt;list&gt;                   &lt;dbl&gt;           &lt;dbl&gt;           &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 &lt;dbl[…]&gt; 1     &lt;PHom [6 × 3]&gt;               0            5.19            0   </span></span>
<span><span class="co">#&gt;  2 &lt;dbl[…]&gt; 6     &lt;PHom [4 × 3]&gt;               0            0               3.85</span></span>
<span><span class="co">#&gt;  3 &lt;dbl[…]&gt; 6     &lt;PHom [4 × 3]&gt;               0            0              15.2 </span></span>
<span><span class="co">#&gt;  4 &lt;dbl[…]&gt; 2     &lt;PHom [4 × 3]&gt;               0            0               0   </span></span>
<span><span class="co">#&gt;  5 &lt;dbl[…]&gt; 7     &lt;PHom [4 × 3]&gt;               0            0               5.33</span></span>
<span><span class="co">#&gt;  6 &lt;dbl[…]&gt; 9     &lt;PHom [4 × 3]&gt;               0            0               7.97</span></span>
<span><span class="co">#&gt;  7 &lt;dbl[…]&gt; 2     &lt;PHom [4 × 3]&gt;               0            0               6.87</span></span>
<span><span class="co">#&gt;  8 &lt;dbl[…]&gt; 0     &lt;PHom [4 × 3]&gt;               0            0               9.98</span></span>
<span><span class="co">#&gt;  9 &lt;dbl[…]&gt; 4     &lt;PHom [4 × 3]&gt;               0            0               5.14</span></span>
<span><span class="co">#&gt; 10 &lt;dbl[…]&gt; 3     &lt;PHom [4 × 3]&gt;               0            0              11.1 </span></span>
<span><span class="co">#&gt; # ℹ 590 more rows</span></span>
<span><span class="co">#&gt; # ℹ 45 more variables: digit_pd_pl_1_4 &lt;dbl&gt;, digit_pd_pl_1_5 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   digit_pd_pl_1_6 &lt;dbl&gt;, digit_pd_pl_1_7 &lt;dbl&gt;, digit_pd_pl_1_8 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   digit_pd_pl_1_9 &lt;dbl&gt;, digit_pd_pl_1_10 &lt;dbl&gt;, digit_pd_pl_1_11 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   digit_pd_pl_1_12 &lt;dbl&gt;, digit_pd_pl_1_13 &lt;dbl&gt;, digit_pd_pl_1_14 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   digit_pd_pl_1_15 &lt;dbl&gt;, digit_pd_pl_1_16 &lt;dbl&gt;, digit_pd_pl_2_1 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   digit_pd_pl_2_2 &lt;dbl&gt;, digit_pd_pl_2_3 &lt;dbl&gt;, digit_pd_pl_2_4 &lt;dbl&gt;, …</span></span></code></pre></div>
<p>We use the input <code>digit</code> column to finalize the range of
blurs and the derived <code>digit_pd</code> column to finalize the range
of homological degree. We expect the important topological features of
the digits number at most 2 per image, so we manually prescribe a narrow
range for <code>num_levels</code>, though it could also be learned from
the training set. Each finalized range is printed for reference:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span> <span class="va">blur_sd_fin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dials.tidymodels.org/reference/finalize.html" class="external-link">finalize</a></span><span class="op">(</span><span class="fu"><a href="../reference/blur_sigmas.html">blur_sigmas</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">mnist_train</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">digit</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co">#&gt; Gaussian Blur std. dev.s (quantitative)</span></span>
<span><span class="co">#&gt; Transformer: log1p [-1, Inf]</span></span>
<span><span class="co">#&gt; Range (transformed scale): [0.504, 2.5]</span></span>
<span><span class="op">(</span> <span class="va">pl_deg_fin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dials.tidymodels.org/reference/finalize.html" class="external-link">finalize</a></span><span class="op">(</span><span class="fu"><a href="../reference/hom_degree.html">hom_degree</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">mnist_bake</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">digit_pd</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co">#&gt; Homological Degree (quantitative)</span></span>
<span><span class="co">#&gt; Range: [0, 1]</span></span>
<span><span class="op">(</span> <span class="va">pl_lev_fin</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vpd-dials.html">num_levels</a></span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co">#&gt; # Levels or envelopes (quantitative)</span></span>
<span><span class="co">#&gt; Range: [1, 3]</span></span></code></pre></div>
<p>Note that the homological degree ranges only from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>
to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>
because the image has dimension 2.</p>
</div>
<div class="section level3">
<h3 id="tunable-classification-forest">tunable classification forest<a class="anchor" aria-label="anchor" href="#tunable-classification-forest"></a>
</h3>
<p>As noted earlier, the three hyperparameters of the RF specification
will be treated in different ways: <code>trees</code> fixed at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>300</mn><annotation encoding="application/x-tex">300</annotation></semantics></math>,
<code>min_n</code> tuned over a default grid, and <code>mtry</code>
tuned over a grid learned from the training set.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rand_forest</span><span class="op">(</span></span>
<span>  trees <span class="op">=</span> <span class="fl">300</span>,</span>
<span>  min_n <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="st">"rf_node"</span><span class="op">)</span>,</span>
<span>  mtry <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="st">"rf_pred"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"ranger"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">mnist_spec</span></span>
<span><span class="co">#&gt; Random Forest Model Specification (classification)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Main Arguments:</span></span>
<span><span class="co">#&gt;   mtry = tune("rf_pred")</span></span>
<span><span class="co">#&gt;   trees = 300</span></span>
<span><span class="co">#&gt;   min_n = tune("rf_node")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computational engine: ranger</span></span></code></pre></div>
<p>We can again check for the two tunable hyperparameters by extracting
their dials:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span> <span class="va">spec_dials</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html" class="external-link">extract_parameter_set_dials</a></span><span class="op">(</span><span class="va">mnist_spec</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co">#&gt; Collection of 2 parameters for tuning</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  identifier  type    object</span></span>
<span><span class="co">#&gt;     rf_pred  mtry nparam[?]</span></span>
<span><span class="co">#&gt;     rf_node min_n nparam[+]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model parameters needing finalization:</span></span>
<span><span class="co">#&gt; # Randomly Selected Predictors ('rf_pred')</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See `?dials::finalize()` or `?dials::update.parameters()` for more information.</span></span></code></pre></div>
<p>As seen in the printed dials, one hyperparameter range must be
finalized. The process for doing so is the same as for the recipe, but
in this case the variables of interest are the vectorized features. We
see from the pre-processed data that these features use a consistent
naming convention, and we use this convention to select them for
learning the range:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span> <span class="va">mtry_fin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dials.tidymodels.org/reference/finalize.html" class="external-link">finalize</a></span><span class="op">(</span><span class="fu"><a href="https://dials.tidymodels.org/reference/mtry.html" class="external-link">mtry</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">mnist_bake</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">contains</a></span><span class="op">(</span><span class="st">"_pl_"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co">#&gt; # Randomly Selected Predictors (quantitative)</span></span>
<span><span class="co">#&gt; Range: [1, 48]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="hyperparameter-tuning">hyperparameter tuning<a class="anchor" aria-label="anchor" href="#hyperparameter-tuning"></a>
</h3>
<p>At last we arrive at the crux of this vignette! In preparation for
tuning, we wrap the pre-processing recipe and the model specification in
a workflow:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">mnist_rec</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">mnist_spec</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">mnist_wflow</span></span>
<span><span class="co">#&gt; ══ Workflow ════════════════════════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; Preprocessor: Recipe</span></span>
<span><span class="co">#&gt; Model: rand_forest()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; 3 Recipe Steps</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; • step_blur()</span></span>
<span><span class="co">#&gt; • step_pd_raster()</span></span>
<span><span class="co">#&gt; • step_vpd_persistence_landscape()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ───────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Random Forest Model Specification (classification)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Main Arguments:</span></span>
<span><span class="co">#&gt;   mtry = tune("rf_pred")</span></span>
<span><span class="co">#&gt;   trees = 300</span></span>
<span><span class="co">#&gt;   min_n = tune("rf_node")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computational engine: ranger</span></span></code></pre></div>
<p>One way to systematically optimize the recipe and model
hyperparameters—to tune the dials—is via a grid. This can be important
when the parameters have known trade-offs or the objective function is
expected to have multiple optima, so the investigator wants a
course-grained “map” of how performance varies across the whole
parameter space. For illustration, we construct a workflow grid by
crossing a recipe grid with a model grid:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mnist_rec_grid</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://dials.tidymodels.org/reference/grid_regular.html" class="external-link">grid_regular</a></span><span class="op">(</span><span class="va">blur_sd_fin</span>, <span class="va">pl_deg_fin</span>, <span class="va">pl_lev_fin</span>, levels <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blur_sd"</span>, <span class="st">"pl_deg"</span>, <span class="st">"pl_lev"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mnist_spec_grid</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://dials.tidymodels.org/reference/grid_regular.html" class="external-link">grid_regular</a></span><span class="op">(</span><span class="fu"><a href="https://dials.tidymodels.org/reference/trees.html" class="external-link">min_n</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">mtry_fin</span>, levels <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rf_node"</span>, <span class="st">"rf_pred"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mnist_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">mnist_rec_grid</span>, <span class="va">mnist_spec_grid</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">mnist_grid</span><span class="op">)</span></span>
<span><span class="co">#&gt;      blur_sd pl_deg pl_lev rf_node rf_pred</span></span>
<span><span class="co">#&gt; 1  0.6554575      0      1       2       1</span></span>
<span><span class="co">#&gt; 2  3.5000000      0      1       2       1</span></span>
<span><span class="co">#&gt; 3 11.2322682      0      1       2       1</span></span>
<span><span class="co">#&gt; 4  0.6554575      1      1       2       1</span></span>
<span><span class="co">#&gt; 5  3.5000000      1      1       2       1</span></span>
<span><span class="co">#&gt; 6 11.2322682      1      1       2       1</span></span></code></pre></div>
<p>This approach is not as inefficient as it might seem: As implemented
in Tidymodels, <a href="https://tune.tidymodels.org/articles/extras/optimizations.html" class="external-link">grid
tuning recognizes the order of the pre-processing steps</a>, and
sometimes <a href="https://www.tidymodels.org/learn/work/tune-text/#grid-search" class="external-link">of
the model construction</a>, and only performs each step once for every
combination of subsequent steps, using the temporarily stored results
rather than recomputing them from scratch. The unexecuted code chunk
below shows the syntax for conducting this grid search:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mnist_res</span> <span class="op">&lt;-</span> <span class="fu">tune_grid</span><span class="op">(</span></span>
<span>  <span class="va">mnist_wflow</span>,</span>
<span>  resamples <span class="op">=</span> <span class="va">mnist_folds</span>,</span>
<span>  grid <span class="op">=</span> <span class="va">mnist_grid</span>,</span>
<span>  metrics <span class="op">=</span> <span class="fu">metric_set</span><span class="op">(</span><span class="va">accuracy</span>, <span class="va">roc_auc</span><span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="fu">control_grid</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Still, however, due to the exceptionally costly computations
involved, a more targeted search is preferable. For this reason, <a href="https://ieeexplore.ieee.org/abstract/document/8999182" class="external-link">Motta,
Tralie, &amp;al (2019)</a> recommend Bayesian optimization for ML using
topological features. This procedure is also implemented in Tidymodels
and executed below. First, we combine the extracted dials from the
pre-processing recipe and the model specification and update them with
the finalized ranges:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wflow_dials</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">rec_dials</span>, <span class="va">spec_dials</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span>blur_sd <span class="op">=</span> <span class="va">blur_sd_fin</span>, pl_deg <span class="op">=</span> <span class="va">pl_deg_fin</span>, pl_lev <span class="op">=</span> <span class="va">pl_lev_fin</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span>rf_pred <span class="op">=</span> <span class="va">mtry_fin</span><span class="op">)</span></span></code></pre></div>
<p>The tuning syntax is similar to that of the grid search, but in place
of the grid we only provide the updated dials. We specify 6 initial
seeds with 12 tuning iterations each.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>mnist_res <span class="ot">&lt;-</span> <span class="fu">tune_bayes</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  mnist_wflow,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamples =</span> mnist_folds,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">param_info =</span> wflow_dials,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">metric_set</span>(accuracy, roc_auc),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">initial =</span> <span class="dv">6</span>, <span class="at">iter =</span> <span class="dv">12</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; → A | warning: ! 19 columns were requested but there were 16 predictors in the data.</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;                ℹ 16 predictors will be used.</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x1 [K</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a> [K→ B <span class="sc">|</span> warning<span class="sc">:</span> <span class="sc">!</span> <span class="dv">48</span> columns were requested but there were <span class="dv">32</span> predictors <span class="cf">in</span> the data.</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;                ℹ 32 predictors will be used.</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; There were issues with some computations   A: x1</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x1   B<span class="sc">:</span> x1 [K</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a> [K→ C <span class="sc">|</span> warning<span class="sc">:</span> <span class="sc">!</span> <span class="dv">38</span> columns were requested but there were <span class="dv">16</span> predictors <span class="cf">in</span> the data.</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;                ℹ 16 predictors will be used.</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; There were issues with some computations   A: x1   B: x1</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x1   B<span class="sc">:</span> x1   C<span class="sc">:</span> x1 [K</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x2   B<span class="sc">:</span> x1   C<span class="sc">:</span> x1 [K</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x2   B<span class="sc">:</span> x2   C<span class="sc">:</span> x1 [K</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x2   B<span class="sc">:</span> x2   C<span class="sc">:</span> x2 [K</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x3   B<span class="sc">:</span> x2   C<span class="sc">:</span> x2 [K</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x3   B<span class="sc">:</span> x3   C<span class="sc">:</span> x2 [K</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x3   B<span class="sc">:</span> x3   C<span class="sc">:</span> x3 [K</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x4   B<span class="sc">:</span> x3   C<span class="sc">:</span> x3 [K</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x4   B<span class="sc">:</span> x4   C<span class="sc">:</span> x3 [K</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x4   B<span class="sc">:</span> x4   C<span class="sc">:</span> x4 [K</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x5   B<span class="sc">:</span> x4   C<span class="sc">:</span> x4 [K</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x5   B<span class="sc">:</span> x5   C<span class="sc">:</span> x4 [K</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x5   B<span class="sc">:</span> x5   C<span class="sc">:</span> x5 [K</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x6   B<span class="sc">:</span> x5   C<span class="sc">:</span> x5 [K</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x6   B<span class="sc">:</span> x6   C<span class="sc">:</span> x5 [K</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x6   B<span class="sc">:</span> x6   C<span class="sc">:</span> x6 [K</span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a><span class="sc">!</span> The Gaussian process model is being fit using <span class="dv">5</span> features but only has <span class="dv">6</span></span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   data points to do so. This may cause errors or a poor model fit.</span></span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a> [K→ D <span class="sc">|</span> warning<span class="sc">:</span> <span class="sc">!</span> <span class="dv">35</span> columns were requested but there were <span class="dv">32</span> predictors <span class="cf">in</span> the data.</span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;                ℹ 32 predictors will be used.</span></span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; There were issues with some computations   A: x6   B: x6   C: x6</span></span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x6   B<span class="sc">:</span> x6   C<span class="sc">:</span> x6   D<span class="sc">:</span> x1 [K</span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x6   B<span class="sc">:</span> x6   C<span class="sc">:</span> x6   D<span class="sc">:</span> x2 [K</span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x6   B<span class="sc">:</span> x6   C<span class="sc">:</span> x6   D<span class="sc">:</span> x3 [K</span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x6   B<span class="sc">:</span> x6   C<span class="sc">:</span> x6   D<span class="sc">:</span> x4 [K</span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x6   B<span class="sc">:</span> x6   C<span class="sc">:</span> x6   D<span class="sc">:</span> x5 [K</span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x6   B<span class="sc">:</span> x6   C<span class="sc">:</span> x6   D<span class="sc">:</span> x6 [K</span>
<span id="cb26-72"><a href="#cb26-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-73"><a href="#cb26-73" aria-hidden="true" tabindex="-1"></a>There were issues with some computations   A<span class="sc">:</span> x6   B<span class="sc">:</span> x6   C<span class="sc">:</span> x6   D<span class="sc">:</span> x6 [K</span></code></pre></div>
<p>Whereas in the previous section we fit only a single model, in this
section we have obtained results for numerous hyperparameter settings
and must choose among them for the final model. We first inspect the top
several models, for a sense of how rapidly performance drops away from
the optimal settings, then select the top-performing settings for the
final model. We computed both accuracy and area under the ROC curve, but
we use only the former to inform this choice.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">collect_metrics</span><span class="op">(</span><span class="va">mnist_res</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.metric</span> <span class="op">==</span> <span class="st">"accuracy"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 18 × 12</span></span>
<span><span class="co">#&gt;    blur_sd pl_deg pl_lev rf_pred rf_node .metric  .estimator  mean     n std_err</span></span>
<span><span class="co">#&gt;      &lt;dbl&gt;  &lt;int&gt;  &lt;int&gt;   &lt;int&gt;   &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1   0.776      0      3      29      39 accuracy multiclass 0.47      6  0.0214</span></span>
<span><span class="co">#&gt;  2   0.985      0      2       6      31 accuracy multiclass 0.442     6  0.0154</span></span>
<span><span class="co">#&gt;  3   0.682      0      3      22      27 accuracy multiclass 0.438     6  0.0158</span></span>
<span><span class="co">#&gt;  4   0.671      0      2      35      39 accuracy multiclass 0.428     6  0.0189</span></span>
<span><span class="co">#&gt;  5   0.717      0      3      43      33 accuracy multiclass 0.427     6  0.0186</span></span>
<span><span class="co">#&gt;  6   0.993      0      2      27      23 accuracy multiclass 0.427     6  0.0167</span></span>
<span><span class="co">#&gt;  7   0.952      0      1       9      30 accuracy multiclass 0.403     6  0.0174</span></span>
<span><span class="co">#&gt;  8   0.880      0      3       1      38 accuracy multiclass 0.39      6  0.01  </span></span>
<span><span class="co">#&gt;  9   4.50       0      3      10      32 accuracy multiclass 0.387     6  0.0120</span></span>
<span><span class="co">#&gt; 10   0.655      0      1      19      17 accuracy multiclass 0.368     6  0.0199</span></span>
<span><span class="co">#&gt; 11   1.68       0      3      28      34 accuracy multiclass 0.3       6  0.0188</span></span>
<span><span class="co">#&gt; 12   2.68       1      2      48      40 accuracy multiclass 0.283     6  0.0136</span></span>
<span><span class="co">#&gt; 13   5.17       0      2       3      31 accuracy multiclass 0.28      6  0.0258</span></span>
<span><span class="co">#&gt; 14   2.03       0      1       8      23 accuracy multiclass 0.273     6  0.0158</span></span>
<span><span class="co">#&gt; 15   8.87       0      2      13       2 accuracy multiclass 0.258     6  0.0250</span></span>
<span><span class="co">#&gt; 16   1.47       1      3      29       2 accuracy multiclass 0.21      6  0.0155</span></span>
<span><span class="co">#&gt; 17  11.2        0      1      38       9 accuracy multiclass 0.175     6  0.0138</span></span>
<span><span class="co">#&gt; 18   7.20       1      2       1      24 accuracy multiclass 0.142     6  0.0247</span></span>
<span><span class="co">#&gt; # ℹ 2 more variables: .config &lt;chr&gt;, .iter &lt;int&gt;</span></span>
<span><span class="op">(</span><span class="va">mnist_best</span> <span class="op">&lt;-</span> <span class="fu">select_best</span><span class="op">(</span><span class="va">mnist_res</span>, metric <span class="op">=</span> <span class="st">"accuracy"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 6</span></span>
<span><span class="co">#&gt;   blur_sd pl_deg pl_lev rf_pred rf_node .config</span></span>
<span><span class="co">#&gt;     &lt;dbl&gt;  &lt;int&gt;  &lt;int&gt;   &lt;int&gt;   &lt;int&gt; &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1   0.776      0      3      29      39 Iter6</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fitting-and-evaluation-1">fitting and evaluation<a class="anchor" aria-label="anchor" href="#fitting-and-evaluation-1"></a>
</h3>
<p>Now, finally, we fit the tuned model to the training set:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mnist_fin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="fu">finalize_recipe</span><span class="op">(</span><span class="va">mnist_rec</span>, <span class="va">mnist_best</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">fit</span><span class="op">(</span></span>
<span>  <span class="fu">finalize_model</span><span class="op">(</span><span class="va">mnist_spec</span>, <span class="va">mnist_best</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">mnist_fin</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span><span class="va">mnist_fin</span>, new_data <span class="op">=</span> <span class="va">mnist_train</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">mnist_fit</span></span>
<span><span class="co">#&gt; parsnip model object</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Ranger result</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt;  ranger::ranger(x = maybe_data_frame(x), y = y, mtry = min_cols(~29L,      x), num.trees = ~300, min.node.size = min_rows(~39L, x),      num.threads = 1, verbose = FALSE, seed = sample.int(10^5,          1), probability = TRUE) </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Type:                             Probability estimation </span></span>
<span><span class="co">#&gt; Number of trees:                  300 </span></span>
<span><span class="co">#&gt; Sample size:                      600 </span></span>
<span><span class="co">#&gt; Number of independent variables:  48 </span></span>
<span><span class="co">#&gt; Mtry:                             29 </span></span>
<span><span class="co">#&gt; Target node size:                 39 </span></span>
<span><span class="co">#&gt; Variable importance mode:         none </span></span>
<span><span class="co">#&gt; Splitrule:                        gini </span></span>
<span><span class="co">#&gt; OOB prediction error (Brier s.):  0.5064056</span></span></code></pre></div>
<p>The resulting RF correctly classifies roughly half of the images “out
of bag”—not great, but much better than the model using intuited
hyperparameter values (and than pure chance). (Note also that the
<code>blur</code> standard deviation is lower than originally defaulted
to.) As before, we can look to the confusion matrix for insights into
the sources of error:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mnist_fit</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span><span class="va">mnist_fin</span>, new_data <span class="op">=</span> <span class="va">mnist_train</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">mnist_train</span>, <span class="va">label</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">mnist_pred</span></span>
<span><span class="co">#&gt; # A tibble: 600 × 2</span></span>
<span><span class="co">#&gt;    .pred_class label</span></span>
<span><span class="co">#&gt;    &lt;fct&gt;       &lt;fct&gt;</span></span>
<span><span class="co">#&gt;  1 1           1    </span></span>
<span><span class="co">#&gt;  2 6           6    </span></span>
<span><span class="co">#&gt;  3 6           6    </span></span>
<span><span class="co">#&gt;  4 2           2    </span></span>
<span><span class="co">#&gt;  5 1           7    </span></span>
<span><span class="co">#&gt;  6 9           9    </span></span>
<span><span class="co">#&gt;  7 7           2    </span></span>
<span><span class="co">#&gt;  8 0           0    </span></span>
<span><span class="co">#&gt;  9 4           4    </span></span>
<span><span class="co">#&gt; 10 3           3    </span></span>
<span><span class="co">#&gt; # ℹ 590 more rows</span></span>
<span><span class="va">mnist_pred</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">conf_mat</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">label</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span><span class="co">#&gt;           Truth</span></span>
<span><span class="co">#&gt; Prediction  0  1  2  3  4  5  6  7  8  9</span></span>
<span><span class="co">#&gt;          0 50  0  0  1  0  0  3  0  1  2</span></span>
<span><span class="co">#&gt;          1  0 51  2  5  7  6  1 13  0  0</span></span>
<span><span class="co">#&gt;          2  2  1 26  0  0  1  2  0  4  4</span></span>
<span><span class="co">#&gt;          3  0  1  4 26  4  2  3  2  0  1</span></span>
<span><span class="co">#&gt;          4  0  0  9  2 35  6  1  8  0  0</span></span>
<span><span class="co">#&gt;          5  0  1  6 18  3 37  0  7  0  0</span></span>
<span><span class="co">#&gt;          6  2  0  4  0  2  0 41  0  3  7</span></span>
<span><span class="co">#&gt;          7  1  6  6  7  6  7  5 30  0  1</span></span>
<span><span class="co">#&gt;          8  2  0  1  0  0  0  1  0 49  1</span></span>
<span><span class="co">#&gt;          9  3  0  2  1  3  1  3  0  3 44</span></span>
<span><span class="va">mnist_pred</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">accuracy</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">label</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 3</span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 accuracy multiclass     0.648</span></span></code></pre></div>
<p>Among the most-confused digits in previous runs of these experiments
are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>7</mn><annotation encoding="application/x-tex">7</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>5</mn><annotation encoding="application/x-tex">5</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>3</mn><annotation encoding="application/x-tex">3</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>5</mn><annotation encoding="application/x-tex">5</annotation></semantics></math>.
(The results above should be similar but will depend somewhat on the
state of the random number generator.) This is more in keeping with the
topological similarities of the digits, though geometry is also clearly
playing a role.</p>
<p>Finally, we evaluate the final model on the testing set—the holdout
data from the original partition.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mnist_fit</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span><span class="va">mnist_fin</span>, new_data <span class="op">=</span> <span class="va">mnist_test</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">mnist_test</span>, <span class="va">label</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">mnist_pred</span></span>
<span><span class="co">#&gt; # A tibble: 100 × 2</span></span>
<span><span class="co">#&gt;    .pred_class label</span></span>
<span><span class="co">#&gt;    &lt;fct&gt;       &lt;fct&gt;</span></span>
<span><span class="co">#&gt;  1 5           0    </span></span>
<span><span class="co">#&gt;  2 1           1    </span></span>
<span><span class="co">#&gt;  3 4           4    </span></span>
<span><span class="co">#&gt;  4 1           1    </span></span>
<span><span class="co">#&gt;  5 2           2    </span></span>
<span><span class="co">#&gt;  6 0           0    </span></span>
<span><span class="co">#&gt;  7 4           4    </span></span>
<span><span class="co">#&gt;  8 9           9    </span></span>
<span><span class="co">#&gt;  9 9           6    </span></span>
<span><span class="co">#&gt; 10 0           0    </span></span>
<span><span class="co">#&gt; # ℹ 90 more rows</span></span>
<span><span class="va">mnist_pred</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">conf_mat</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">label</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span><span class="co">#&gt;           Truth</span></span>
<span><span class="co">#&gt; Prediction  0  1  2  3  4  5  6  7  8  9</span></span>
<span><span class="co">#&gt;          0  8  0  0  0  0  0  1  0  0  0</span></span>
<span><span class="co">#&gt;          1  0 10  1  0  0  1  0  1  0  0</span></span>
<span><span class="co">#&gt;          2  0  0  5  1  0  0  1  0  0  2</span></span>
<span><span class="co">#&gt;          3  0  0  0  1  0  2  3  2  1  0</span></span>
<span><span class="co">#&gt;          4  0  0  0  0  5  2  1  4  0  0</span></span>
<span><span class="co">#&gt;          5  1  0  2  5  2  4  0  0  0  0</span></span>
<span><span class="co">#&gt;          6  0  0  2  0  1  0  2  0  1  1</span></span>
<span><span class="co">#&gt;          7  0  0  0  3  2  1  0  3  0  0</span></span>
<span><span class="co">#&gt;          8  0  0  0  0  0  0  0  0  8  0</span></span>
<span><span class="co">#&gt;          9  1  0  0  0  0  0  2  0  0  7</span></span>
<span><span class="va">mnist_pred</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">accuracy</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">label</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 3</span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 accuracy multiclass      0.53</span></span></code></pre></div>
<p>Some patterns in the training set hold up, though others don’t, and
some frequent confusion pairings are new. The accuracy is significantly
lower than on the training set—a reminder of the importance of
out-of-box evaluation—though significantly higher than the untuned
model. While the sample is small, we can say with confidence that
topological features discriminate among them, and much more effectively
after hyperparameter optimization.</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jason Cory Brunson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
